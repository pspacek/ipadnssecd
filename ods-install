dnf install opendnssec softhsm2 -y
softhsm2-util --so-pin 1234 --slot 0 --label OpenDNSSEC --pin 1234 --init-token

# workarounds for packaging bugs in opendnssec-1.4.5-2.fc20.x86_64: https://bugzilla.redhat.com/show_bug.cgi?id=1098188
chown -cR root:ods /etc/opendnssec
chmod -cR ug+rw,o= /etc/opendnssec
chown -cR ods: /var/{softhsm,opendnssec}
chmod -cR ug+rw,o= /var/{softhsm,opendnssec}
echo y | sudo -u ods -g ods ods-ksmutil setup

# comment out <Signer> section in /etc/opendnssec/conf.xml

# Modify /etc/opendnssec/conf.xml - replace
# <Module>/usr/lib64/softhsm2/libsofthsm.so</Module>
# with
# <Module>/usr/lib64/softhsm2/libsofthsm2.so</Module>

# maybe this should be done in ipactl
sudo systemctl enable ods-enforcerd.service
sudo systemctl start  ods-enforcerd.service

# IPA never wants original signer
sudo systemctl stop ods-signerd.service
sudo systemctl disable ods-signerd.service
sudo systemctl mask ods-signerd.service

ipa service-add ipadnssecd/$(hostname)
ipa-getkeytab -s $(hostname) -k /etc/ipa/ipadnssecd.keytab -p ipadnssecd/$(hostname)
chown -c ods: /etc/ipa/ipadnssecd.keytab
chmod -c o= /etc/ipa/ipadnssecd.keytab
